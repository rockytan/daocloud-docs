---
title: '「Allen 谈 Docker 系列」之 Docker 容器日志的那些事儿'
---

<!-- reviewed by fiona -->

>**「Allen 谈 Docker 系列」**

>DaoCloud 正在启动 Docker 技术系列文章，每周都会为大家推送一期真材实料的精选 Docker 文章。主讲人为 DaoCloud 核心开发团队成员 Allen（孙宏亮），他是 InfoQ 「Docker 源码分析」专栏作者，已出版《Docker 源码分析》一书。Allen 接触 Docker 近两年，爱钻研系统实现原理，及 Linux 操作系统。

---

如果时光可以倒流，现实世界的每一步都可以分解到最小，记录下来，就是日志。万物即日志。

面对历史，审视日志，可以选择忘却，也可以选择铭记；经历过的，可以选择珍藏，同样也可以让它尘封。

Docker 容器又何尝不是？日志就像一根时间轴，你在或者不在，他都在那。有人对其善意，有人却对其随意。如若不信，可以回忆，自己是否善待 Docker 容器的日志。

## 1. 传统应用的日志

如若不是被过去伤得太深，踏入一个新的世界，应该还是会怀念过往的吧。新世界的「诱惑」与崭新的节奏，相信依旧无法掩盖旧世界的铅印。数十年岁月，应用的生命是如何在记录？

**1.1 很多人注重结果，对过程可能不闻不问，应用的日志可能随着标准输出（stdout）和标准错误（stderr）扬长而去，无法捕捉，无法定格，结果不如意时万分嗟叹；**

**1.2 红袖添香，满腹经纶的才子也许会赋诗一首，书于内墙。故地重游，即唤起那良宵之夜。应用的日志也是如此，有心之人也会记录日志（赋诗一首），持久化至某处（书于内墙），便于他日查阅。**

**1.3 随时随地都可以吟诗题字，古人走万里路，相信很难将所有的题诗悉数记忆。不管多远，如果记忆可以藏在一处便于日后美忆，方为上策。十年前，陈老师那一台电脑做到了；去年，大表姐的手机也帮她做到了。人生如此，遑论日志。日志日志，其实应用的日志也可以发往某处，集中处理。**

## 2. Docker 时代的日志

Docker 时代的日志，步子并未跨得太大，毕竟安全第一。然而，不可否认发展的时代总有让你意想不到的亮点。

如果你是容器中的应用，哪怕你是始乱终弃，抑或是洒脱不羁，Docker 容器都会记录下你的点点滴滴，只要你对着标准输出标准错误说一句 「action」。（Docker 容器所有的标准输出标准错误都会被 Docker Daemon 接管。）

如果你是个阅尽人间无数，拳打南山，脚踢北海，四海流窜的 Docker 容器，你在北京的 One Night，兴许第二天在上海的你早已酒醒如初；第三天出差杭州的你，更是不记得昨天在上海住的是几星级宾馆。（Docker 容器本身理应尽量无状态，容器内应用持久化的日志则有状态，频繁迁移不宜容器日志管理。）

如果你有一部肾机，如果你继续支持大表姐。Docker 容器中的你，很容易将容器走南闯北的经历传至云端，以便他日传看。（Docker 容器的应用日志，如果自己发往集中的日志处理中心，则为上上策，易统一；问题是成本高，得有钱买肾机，还需统一化的标准。）

## 3. 获取 Docker 容器持久化日志

阅尽人间无数，却难忆点滴，想必并非君台所愿。梦醒时分，如何获悉北京 One Night 的一切，现授君些许技巧，从而轻易输送应用在 Docker 容器内部持久化的日志。

如果你已经熟知 docker logs 的原理，那么标准输出标准错误的那些事儿，在你看来自然不在话下。如果再加上一些 `Dockerfile` 的 CMD 知识，以下内容的理解自然也是水到渠成。

**目标**：通过标准输出，传递 Docker 容器内部的应用持久化日志文件。

**方法**：简单重构应用 `Dockerfile` 的 CMD 指令。

**问题假设**：原先应用 `Dockerfile` 的 CMD 指令为 `CMD ["python", "app.py"]`，应用打印日志的路径为 `/var/log/app.log`。

**具体实现**：

- **第一步**：

原先 `Dockerfile` 所在目录下，创建一个 `run.sh` 文件，文件内容为：

```bash
#!/bin/bash
tail -F /var/log/app.log &
exec python app.py
```

- **第二步**：

修改 `Dockerfile`，删除原先的 `CMD`，替换为三个指令。

* 指令一：`ADD run.sh /`
* 指令二：`RUN chmod +x run.sh`
* 指令三：`CMD ["./run.sh"]`

**原理剖析**：

`run.sh` 中启动了一个后台进程，使用 `tail` 命令强制将 `/var/log/app.log` 的内容传输至标准输出，随后使用 `exec` 命令将 `python app.py` 作为容器的主进程运行。

**示意图**：

![示意图](http://7xi8kv.com5.z0.glb.qiniucdn.com/docker日志.png)

新的纪元来临，技术革命带来巨大便利时，也许也需要稍微改变下原先的做法，Docker 容器的日志管理也是如此。毕竟 One Night in 北京，只需对 Docker 容器中安个镜头，对他说句 「action」，人力物力都省了，绝对比三里屯的一分钟轻松不少。

大概这样，成本应该还不算高吧。
